library(testthat)
library(opdesmixr)



n_draws = 64
variance = 5
n_random_starts = 8
max_it = 3
seed = 10
n_cox_points = 15
n_cores = parallel::detectCores()


beta_o1_1 = c(1, 2, 3)
beta_o1_2 = c(1, 20, 300)


beta_o1_1_prior_draws = get_halton_draws(beta_o1_1, sd = sqrt(variance), ndraws = n_draws)
beta_o1_2_prior_draws = get_halton_draws(beta_o1_2, sd = sqrt(variance), ndraws = n_draws)


test_that("mnl_bayes_D_q3_J2_S10_o1_seed10",{


  mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_brent = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_1_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "D",
    opt_method = "B",
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)


  mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_discrete = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_1_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "D",
    opt_method = "D",
    n_cox_points = n_cox_points,
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)



  mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_brent = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_2_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "D",
    opt_method = "B",
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)


  mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_discrete = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_2_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "D",
    opt_method = "D",
    n_cox_points = n_cox_points,
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)





  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_brent$X,# %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0, 1, 0, 0.599553726813176, 0, 0.400446273186824, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0.367060211628625, 0, 0.632939788371374, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0.464505666319992, 0.535494333680007, 0, 1, 0, 0, 0, 0.495759869677883, 0.504240130322117, 0, 0, 1, 0, 1, 0),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_brent$opt_crit_value_orig,
    4.74197434079058588
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_brent$opt_crit_value,
    1.95464812616190464
  )




  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_discrete$X,
    array(c(1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0.357142857142857, 0, 0.642857142857143, 0, 1, 0, 0, 1, 0, 0.613041955011968, 0, 0.386958044988032, 1, 0, 0, 0, 0.492214927111283, 0.507785072888717, 0, 0, 1, 0.481888592001468, 0.518111407998532, 0),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_discrete$opt_crit_value_orig,
    4.68843967077425194
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta1_seed10_discrete$opt_crit_value,
    1.95487007361717668
  )





  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_brent$X,# %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0.429095309019819, 0.350066789887771, 0.22083790109241, 0.062244368677384, 0.747892843105428, 0.189862788217187, 0, 0.729930748350213, 0.270069251649787, 0.084750202253344, 0.630857049644236, 0.28439274810242, 0.284634284895778, 0.334495111543917, 0.380870603560304, 0.322722551811129, 0.302376784215955, 0.374900663972916, 0, 0.647996108809469, 0.352003891190531, 0.305914558628356, 0.313882047255281, 0.380203394116363, 0.623931708119052, 0.073348114069371, 0.302720177811577, 0.458198084966653, 0.242209570520016, 0.299592344513331, 0.005880366763407, 0.967848443669258, 0.026271189567335, 0.90867789458246, 0, 0.09132210541754, 0.574709843410116, 0.245791813943364, 0.17949834264652, 0.66851036618187, 0.154010875184744, 0.177478758633386, 0.393644550583415, 0.176647040455799, 0.429708408960787, 0.267982763655411, 0.30248962764881, 0.42952760869578, 0, 1, 0, 0.944271909999159, 0, 0.055728090000841, 0.526619946229583, 0.17352193131605, 0.299858122454367, 0.507287541789909, 0.202744408684658, 0.289968049525433),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_brent$opt_crit_value_orig,
    33.1681720316872131
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_brent$opt_crit_value,
    11.750525258121101
  )




  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_discrete$X, # %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0.399725943734316, 0.400067532244092, 0.200206524021591, 0.141859350272102, 0.667444718224922, 0.190695931502976, 0, 0.742461095823792, 0.257538904176208, 0.156893043838283, 0.581171526191951, 0.261935429969766, 0.305621097386826, 0.299764514567138, 0.394614388046035, 0.314090149876182, 0.294520962243976, 0.391388887879842, 0, 0.606611723302576, 0.393388276697424, 0.230782849941511, 0.349280115739311, 0.419937034319178, 0.668947353973602, 0, 0.331052646026398, 0.503253087131057, 0.168503817240094, 0.328243095628849, 0, 0.901271412459061, 0.098728587540939, 0.747637517213682, 0.104502197092573, 0.147860285693744, 0.456605442815726, 0.394826504083735, 0.148568053100539, 0.456431753040007, 0.406336739618715, 0.137231507341278, 0.359180661128988, 0.222639832396792, 0.41817950647422, 0.267689764838775, 0.302569572101156, 0.429740663060069, 0.122032928407278, 0.856372694204832, 0.021594377387889, 0.915657310340893, 0, 0.084342689659107, 0.548135913816866, 0.101468728465989, 0.350395357717144, 0.347483293243164, 0.324803980255596, 0.32771272650124),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_discrete$opt_crit_value_orig,
    33.1681720316872131
  )

  expect_equal(
    mnl_bayes_D_q3_J2_S10_o1_beta2_seed10_discrete$opt_crit_value,
    12.171199560237838
  )


})








test_that("mnl_bayes_I_q3_J2_S10_o1_seed10",{


  mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_brent = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_1_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "I",
    opt_method = "B",
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)


  mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_discrete = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_1_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "I",
    opt_method = "D",
    n_cox_points = n_cox_points,
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)



  mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_brent = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_2_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "I",
    opt_method = "B",
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)


  mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_discrete = mnl_mixture_coord_exch(
    q = 3,
    J = 2,
    S = 10,
    beta = beta_o1_2_prior_draws,
    n_random_starts = n_random_starts,
    order = 1,
    opt_crit = "I",
    opt_method = "D",
    n_cox_points = n_cox_points,
    plot_designs = F,
    verbose = 0,
    n_cores = n_cores,
    max_it = max_it,
    seed = seed)





  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_brent$X, # %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0.03682477111455, 0, 0.96317522888545, 0, 1, 0, 0, 0, 1, 0.455784577067141, 0.544215422932859, 0, 0, 0, 1, 0.479317151918599, 0.520682848081401, 0, 0, 0, 1, 0.370737072261463, 0.629262927738537, 0, 0.863104075824602, 0.100314750894519, 0, 0, 0.983965559966012, 0, 0, 1, 0, 0.358416349978356, 0, 0.641583650021644, 1, 0, 0, 0, 0.278509686700147, 0.721490313299853, 0.496787217163117, 0.503212782836883, 0, 0, 0, 1, 0, 0, 1, 0.595933104548741, 0.404066895451259, 0, 0, 0, 1, 1, 0, 0),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_brent$opt_crit_value_orig,
    1.27025498287280025
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_brent$opt_crit_value,
    -0.378433707814908538
  )




  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_discrete$X,
    array(c(0, 0, 1, 0, 1, 0, 0, 0, 1, 0.519947786595341, 0.480052213404659, 0, 0, 0, 1, 0.467083223779682, 0.532916776220318, 0, 0, 0, 1, 0.560389373127008, 0.439610626872992, 0, 0, 0.27215940402732, 0.72784059597268, 1, 0, 0, 0.909776988655487, 0, 0.090223011344513, 0.040521770967536, 0.906350312268138, 0.053127916764325, 0, 1, 0, 0.351046741230651, 0, 0.648953258769349, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0.390391853523114, 0.609608146476886, 0, 0, 0, 1, 0.489870361895668, 0.510129638104332, 0),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_discrete$opt_crit_value_orig,
    1.02249821130572127
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta1_seed10_discrete$opt_crit_value,
    -0.378101911194743456
  )





  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_brent$X, # %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0.45782508698583, 0.366862010073707, 0.175312902940463, 0.23720502079804, 0.592863489986011, 0.169931489215949, 0, 0.741989885561864, 0.258010114438136, 0.116023104612361, 0.609415585601275, 0.274561309786364, 0.298267595345955, 0.302492965736617, 0.399239438917427, 0.327970477670926, 0.262190339511874, 0.4098391828172, 0, 0.655685315663767, 0.344314684336233, 0.314592077790594, 0.311635186299699, 0.373772735909708, 0.621987492864244, 0.077422759069434, 0.300589748066322, 0.458035393057816, 0.243356815913343, 0.298607791028841, 0.050484135169831, 0.922736671359484, 0.026779193470685, 0.443646268910522, 0.511719056768725, 0.044634674320753, 0.57696948844141, 0.243254533358086, 0.179775978200504, 0.565772898183749, 0.263779118900633, 0.170447982915618, 0.383105554603686, 0.170158114575861, 0.446736330820454, 0.266878487442995, 0.302880929449055, 0.430240583107949, 0.63356876779432, 0.299981778187736, 0.066449454017944, 0.642972981978462, 0.29875698913917, 0.058270028882368, 0.435765749554798, 0.236676626495963, 0.327557623949239, 0.429642186323897, 0.234641064889746, 0.335716748786357),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_brent$opt_crit_value_orig,
    14.9632333661604218
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_brent$opt_crit_value,
    8.57135870419982915
  )




  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_discrete$X, # %>% as.numeric() %>% round(15) %>% paste(collapse = ", ")
    array(c(0.185445079503941, 0.550109369518221, 0.264445550977838, 0.083996940686121, 0.64931158283521, 0.266691476478669, 0.703495111463807, 0.142857142857143, 0.15364774567905, 0.731111460318048, 0.104054624214189, 0.164833915467763, 0, 0.657145242613549, 0.342854757386451, 0.425166310396636, 0.191856326320337, 0.382977363283028, 0.434122692475712, 0.418352095129287, 0.147525212395002, 0.071428571428571, 0.814432681457743, 0.114138747113686, 0.193652389749744, 0.305873381661522, 0.500474228588733, 0.434854807566794, 0.044814549179841, 0.520330643253365, 0, 0.532257078009662, 0.467742921990338, 0.16933396757622, 0.339529832685218, 0.491136199738562, 0, 0.715013506377902, 0.284986493622098, 0.199710973410612, 0.50949274048558, 0.290796286103808, 0.184833359061649, 0.123442189667668, 0.691724451270683, 0.090716217373394, 0.238925817770665, 0.670357964855941, 0.264007658162511, 0.302109131378388, 0.433883210459101, 0.445220904029402, 0.119151493934798, 0.4356276020358, 0.501018965151826, 0.339694046152896, 0.159286988695278, 0.826113181745809, 0, 0.173886818254191),
          dim = c(3, 2, 10))
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_discrete$opt_crit_value_orig,
    15.3954049638843991
  )

  expect_equal(
    mnl_bayes_I_q3_J2_S10_o1_beta2_seed10_discrete$opt_crit_value,
    8.75284895936663609
  )


})





